rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /violations/{violationId} {
      // 1. Users can only read/write their own violations
      // 4. Allow read access only to authenticated users
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;

      // 1. Users can only write their own violations
      // 3. Validate that numberPlateText is a string and timestamp is a timestamp
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.numberPlateText is string
                    && request.resource.data.timestamp is timestamp;

      // Do not allow updates to violations to maintain data integrity
      allow update: if false;

      // 2. Prevent deletion of violations older than 24 hours
      allow delete: if request.auth != null 
                    && request.auth.uid == resource.data.userId 
                    && request.time - resource.data.timestamp < duration.value(24, 'h');
    }
  }
}
